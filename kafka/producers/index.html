<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Kafka producer - Event Driven Architecture</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Kafka producer";
    var mkdocs_page_input_path = "kafka\\producers.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Event Driven Architecture</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../concepts/">Concepts</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Architecture</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../architecture/">Reference diagrams</a>
                </li>
                <li class="">
                    
    <a class="" href="../../evt-src/">Event Sources</a>
                </li>
                <li class="">
                    
    <a class="" href="../../evt-backbone/">Event Backbone</a>
                </li>
                <li class="">
                    
    <a class="" href="../../evt-action/">Event Actions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../evt-state/">Event Managed States</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/">Event Stream - Kafka architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="https://ibm-cloud-architecture.github.io/refarch-data-ai-analytics/preparation/data-replication/">Data Replication Pattern</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Event Storming</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../methodology/readme/">Event Storming Workshop</a>
                </li>
                <li class="">
                    
    <a class="" href="https://ibm-cloud-architecture.github.io/refarch-kc/analysis/readme/">Applied to Container Shipment Analysis</a>
                </li>
                <li class="">
                    
    <a class="" href="../../methodology/ddd/">Domain driven design</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Event driven patterns</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../evt-microservices/">Microservices</a>
                </li>
                <li class="">
                    
    <a class="" href="../../evt-microservices/ED-patterns/">Event-driven patterns</a>
                </li>
                <li class="">
                    
    <a class="" href="../kafka-stream/">Event streaming processing</a>
                </li>
                <li class="">
                    
    <a class="" href="https://ibm-cloud-architecture.github.io/refarch-data-ai-analytics/preparation/data-replication/">Data Replication Pattern</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../rt-analytics/">Real time analytics</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reference implementations</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="https://ibm-cloud-architecture.github.io/refarch-kc">Container shipment implementation solution</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Product guidances</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../arch/">Kafka architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../readme/">Kafka concepts summary</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Kafka producer</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#producers-considerations">Producers considerations</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#design-considerations">Design considerations</a></li>
        
            <li><a class="toctree-l4" href="#typical-code-structure">Typical code structure</a></li>
        
            <li><a class="toctree-l4" href="#kafka-useful-producer-apis">Kafka useful Producer APIs</a></li>
        
            <li><a class="toctree-l4" href="#properties-to-consider">Properties to consider</a></li>
        
            <li><a class="toctree-l4" href="#how-to-support-exactly-once-delivery">How to support exactly once delivery?</a></li>
        
            <li><a class="toctree-l4" href="#code-examples">Code Examples</a></li>
        
            <li><a class="toctree-l4" href="#more-readings">More readings</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../consumers/">Kafka consumer</a>
                </li>
                <li class="">
                    
    <a class="" href="../FAQ/">Kafka FAQ</a>
                </li>
                <li class="">
                    
    <a class="" href="../../deployments/kafka/">Kafka deployment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../deployments/zookeeper/">Zookeeper deployment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../deployments/eventstreams/Install_Ceph_on_ICP/">Ceph deployment on ICP</a>
                </li>
                <li class="">
                    
    <a class="" href="../../deployments/eventstreams/">Event Streams ICP deployment</a>
                </li>
                <li class="">
                    
    <a class="" href="../monitoring/">Kafka Monitoring</a>
                </li>
                <li class="">
                    
    <a class="" href="../../serverless/">Serverless</a>
                </li>
                <li class="">
                    
    <a class="" href="../../deployments/postgresql/">Postgresql</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../eda-skill-journey/">Skill Journey</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../compendium/">Compendium</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Event Driven Architecture</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Product guidances &raquo;</li>
        
      
    
    <li>Kafka producer</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ibm-cloud-architecture/refarch-eda/edit/master/docs/kafka/producers.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="producers-considerations">Producers considerations</h1>
<p>A producer is a thread safe kafka client API that publishes records to the cluster. It uses buffers, thread pool, and serializer to send data. They are stateless. This is the consumers that are managing the offsets. The assignment of messae to partition is done following different algorithms: round-robin, simple load balancing, or custom defined. </p>
<p>Producers are more simple to implement but still you need to assess some design considerations.</p>
<h2 id="design-considerations">Design considerations</h2>
<p>When developing a record producer you need to assess the following:</p>
<ul>
<li>What is the expected throughput to send events? Event size * average throughput combined with the expected latency help to compute buffer size. By default, the buffer size is set at 32Mb, but can be configured with <code>buffer.memory</code>. (See <a href="https://kafka.apache.org/10/javadoc/org/apache/kafka/clients/producer/ProducerConfig.html">producer configuration API</a></li>
<li>Can the producer batch events together to send them in batch over one send operation? </li>
<li>Is there a risk for loosing communication? Tune the RETRIES_CONFIG and buffer size, and ensure to have at least 3 brokers and even 5 to maintain quorum in case of one failure. The client API is implemented to support reconnection.</li>
<li>Assess <em>exactly once</em> delivery requirement. Look at idempotent producer: retries will not introduce duplicate records.</li>
<li>Where the event timestamp comes from? Should the producer send operation set it or is it loaded from external data? Remember that <code>LogAppendTime</code> is considered to be processing time, and <code>CreateTime</code> is considered to be event time.</li>
</ul>
<p>See related discussions <a href="https://www.confluent.io/blog/put-several-event-types-kafka-topic/">on confluent web site.</a></p>
<h2 id="typical-code-structure">Typical code structure</h2>
<p>The producer code does the following steps:</p>
<ul>
<li>define producer properties</li>
<li>create a producer instance</li>
<li>send event records and get resulting metadata. </li>
</ul>
<p>Producers are thread safe. The send() operation is asynchronous and returns immediately once record has been stored in the buffer of records, and it is possible to add a callback to process the broker acknowledgement. </p>
<h2 id="kafka-useful-producer-apis">Kafka useful Producer APIs</h2>
<p>Here is a list of common API to use in your producer and consumer code.</p>
<ul>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html">KafkaProducer</a> A Kafka client that publishes records to the Kafka cluster.  The send method is asynchronous. A producer is thread safe so we can have per topic to interface. </li>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/ProducerRecord.html">ProducerRecord</a> to be published to a topic</li>
<li><a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/producer/RecordMetadata.html">RecordMetadata</a> metadata for a record that has been acknowledged by the server.</li>
</ul>
<h2 id="properties-to-consider">Properties to consider</h2>
<p>The following properties are helpful to tune at each topic and producer and will vary depending on the deployment:  </p>
<table>
<thead>
<tr>
<th>Properties</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOOTSTRAP_SERVERS_CONFIG</td>
<td>A comma-separated list of host:port values for all the brokers deployed. So producer may use any brokers</td>
</tr>
<tr>
<td>KEY_SERIALIZER_CLASS_CONFIG and VALUE_SERIALIZER_CLASS_CONFIG</td>
<td>convert the keys and values into byte arrays. Using default String serializer should be a good solution for Json payload. For streaming app, use customer serializer.</td>
</tr>
<tr>
<td>ACKS_CONFIG</td>
<td>specifies the minimum number of acknowledgments from a broker that the producer will wait for before considering a record send completed. Values = all, 0, and 1. 0 is for fire and forget.</td>
</tr>
<tr>
<td>RETRIES_CONFIG</td>
<td>specifies the number of times to attempt to resend a batch of events.</td>
</tr>
<tr>
<td>ENABLE_IDEMPOTENCE_CONFIG</td>
<td>Set to true, the number of retries will be maximized, and the acks will be set to <code>All</code>.</td>
</tr>
</tbody>
</table>
<h2 id="how-to-support-exactly-once-delivery">How to support exactly once delivery?</h2>
<p>Knowing that exactly once delivery is one of the hardest problems to solve in distributed systems, how kafka does it?. Broker can fail or a network may respond slowly while a producer is trying to send events. </p>
<p>Producer can set acknowledge level to control the delivery semantic:</p>
<ul>
<li>At least once: means the producer set ACKS_CONFIG=all and get an acknowledgement message when the message has been written at least one time in the cluster (assume replicas = 3).  If the ack is not received, the producer may retry, which may generate duplicate records in case the broker stops after saving to the topic and before sending back the acknowledgement message.</li>
<li>At most semantic: means the producer will not do retry in case of no acknowldege received. It may create log and compensation, but the message is lost.</li>
<li>Exactly once means even if the producer sends the message twice the system will send only one message to the consumer. Once the consumer commits the read offset, it will not receive the message again, even if it restarts. Consumer offset needs to be in sync with produced event.</li>
</ul>
<p>With the identpotence property (ENABLE_IDEMPOTENCE_CONFIG = true), the record sent has a sequence number, that the broker will consider to avoid having duplicate records per partition. The sequence number is persisted in a log so event in case of broker leader failure, the new leader will have a good view of the states of the system. </p>
<div class="admonition note">
<p class="admonition-title">Note<p>The replication mechanism guarantees that when a message is written to the leader replica, it will be replicated to all available replicas.</p>
</p>
</div>
<p>To add to these, as topic may have multiple partitions, kafka supports atomic writes to all partitions, so that all records are saved or none of them are visible to consumers. This transaction control is done by using the producer transactional API, and a unique transaction identifier to keep integrated state. The consumer is also interested to configure the reading of the transactional messages by defining the isolation level. </p>
<p>Read <a href="https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/">this article</a> from confluent.</p>
<h2 id="code-examples">Code Examples</h2>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-asset-analytics/blob/master/asset-event-producer/src/main/java/ibm/cte/kafka/play/SimpleProducer.java">Simple text message</a></li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-asset-analytics/tree/master/asset-event-producer#pump-simulator">A Pump simulator</a></li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-ms">Ship movement and container metrics event producers</a></li>
</ul>
<h2 id="more-readings">More readings</h2>
<p>*<a href="http://cloudurable.com/blog/kafka-tutorial-kafka-producer-advanced-java-examples/index.html">Creating advanced kafka producer in java - Cloudurable</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../consumers/" class="btn btn-neutral float-right" title="Kafka consumer">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../readme/" class="btn btn-neutral" title="Kafka concepts summary"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/ibm-cloud-architecture/refarch-eda/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../readme/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../consumers/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
